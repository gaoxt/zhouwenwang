# å‘¨æ–‡ç‹å åœç³»ç»Ÿåç«¯æœåŠ¡ ğŸ”®

è¿™æ˜¯ä¸“é—¨ä¸ºå‘¨æ–‡ç‹å åœç³»ç»Ÿè®¾è®¡çš„åç«¯APIæœåŠ¡ï¼Œä¸»è¦ç”¨äºå®‰å…¨åœ°ä¸Gemini APIäº¤äº’ï¼Œå¹¶æä¾›**æµå¼å“åº”**åŠŸèƒ½ï¼Œè®©ç”¨æˆ·åœ¨å åœè¿‡ç¨‹ä¸­æ„Ÿå—åˆ°å®æ—¶çš„"å¯¹è¯ä½“éªŒ"ã€‚

## âœ¨ æ ¸å¿ƒç‰¹æ€§

- ğŸŒŸ **æµå¼AIå“åº”** - å®æ—¶æ˜¾ç¤ºå åœåˆ†æè¿‡ç¨‹ï¼Œæ¨¡æ‹ŸçœŸå®å¯¹è¯
- ğŸ”’ **APIå¯†é’¥å®‰å…¨** - APIå¯†é’¥å®Œå…¨éšè—åœ¨åç«¯ï¼Œå‰ç«¯æ— æ³•è·å–
- ğŸš€ **é«˜æ€§èƒ½** - æ”¯æŒå¹¶å‘è¯·æ±‚ï¼Œç¨³å®šå¯é 
- ğŸ“± **è·¨å¹³å°å…¼å®¹** - æ”¯æŒWebå’Œç§»åŠ¨ç«¯è®¿é—®
- ğŸŒ **å±€åŸŸç½‘å‹å¥½** - ä¸€å°æœåŠ¡å™¨ï¼Œå¤šäººå…±äº«ä½¿ç”¨

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
cd backend
npm install
```

### 2. é…ç½®ç¯å¢ƒå˜é‡

```bash
# å¤åˆ¶ç¤ºä¾‹é…ç½®æ–‡ä»¶
cp env.example .env

# ç¼–è¾‘é…ç½®æ–‡ä»¶
nano .env  # æˆ–ä½¿ç”¨ä½ å–œæ¬¢çš„ç¼–è¾‘å™¨
```

åœ¨ `.env` æ–‡ä»¶ä¸­è®¾ç½®ï¼š
```env
# å¿…éœ€ï¼šä½ çš„Gemini APIå¯†é’¥
GEMINI_API_KEY=AIzaSyC...ä½ çš„APIå¯†é’¥...

# å¯é€‰ï¼šæœåŠ¡å™¨ç«¯å£ï¼ˆé»˜è®¤3001ï¼‰
PORT=3001

# å¯é€‰ï¼šå…è®¸çš„å‰ç«¯åŸŸå
ALLOWED_ORIGINS=http://localhost:5173,http://192.168.1.*
```

### 3. å¯åŠ¨æœåŠ¡

```bash
# æ–¹å¼ä¸€ï¼šä½¿ç”¨å¯åŠ¨è„šæœ¬ï¼ˆæ¨èï¼‰
chmod +x start.sh
./start.sh

# æ–¹å¼äºŒï¼šç›´æ¥å¯åŠ¨
npm start

# æ–¹å¼ä¸‰ï¼šå¼€å‘æ¨¡å¼ï¼ˆè‡ªåŠ¨é‡å¯ï¼‰
npm run dev
```

### 4. éªŒè¯æœåŠ¡

æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š`http://localhost:3001/api/health`

å¦‚æœçœ‹åˆ°ä»¥ä¸‹å“åº”ï¼Œè¯´æ˜æœåŠ¡å¯åŠ¨æˆåŠŸï¼š
```json
{
  "status": "ok",
  "timestamp": "2024-01-15T...",
  "apiConfigured": true,
  "version": "1.0.0"
}
```

## ğŸ“¡ API ç«¯ç‚¹

### æ ¸å¿ƒç«¯ç‚¹

| ç«¯ç‚¹ | æ–¹æ³• | æè¿° | ç‰¹è‰² |
|------|------|------|------|
| `/api/health` | GET | å¥åº·æ£€æŸ¥ | éªŒè¯æœåŠ¡çŠ¶æ€ |
| `/api/gemini/stream` | POST | **ğŸŒŸ æµå¼æ–‡æœ¬ç”Ÿæˆ** | **æ¨èä½¿ç”¨** |
| `/api/gemini/generate` | POST | æ ‡å‡†æ–‡æœ¬ç”Ÿæˆ | å¤‡ç”¨æ–¹æ¡ˆ |
| `/api/gemini/vision` | POST | å›¾åƒåˆ†æ | æ‰‹ç›¸ç­‰ |
| `/api/gemini/vision-stream` | POST | æµå¼å›¾åƒåˆ†æ | æ‰‹ç›¸æµå¼ |
| `/api/validate` | GET | APIå¯†é’¥éªŒè¯ | æµ‹è¯•é…ç½® |

### ğŸŒŸ æµå¼APIä½¿ç”¨ç¤ºä¾‹

**å…­çˆ»å åœæµå¼åˆ†æï¼š**
```javascript
// è°ƒç”¨æµå¼API
fetch('http://localhost:3001/api/gemini/stream', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    contents: [
      {
        parts: [{ text: "è¯·åˆ†æè¿™ä¸ªå…­çˆ»å¦è±¡..." }]
      }
    ]
  })
})
.then(response => {
  const reader = response.body.getReader();
  const decoder = new TextDecoder();
  
  function readStream() {
    return reader.read().then(({ done, value }) => {
      if (done) return;
      
      const chunk = decoder.decode(value);
      // å¤„ç†æœåŠ¡å™¨å‘é€çš„äº‹ä»¶
      const lines = chunk.split('\n');
      
      for (const line of lines) {
        if (line.startsWith('data: ')) {
          const data = JSON.parse(line.slice(6));
          if (data.text) {
            // å®æ—¶æ›´æ–°UIæ˜¾ç¤º
            updateDivinationText(data.text);
          }
        }
      }
      
      return readStream();
    });
  }
  
  return readStream();
});
```

## ğŸ”§ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡

| å˜é‡ | å¿…éœ€ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `GEMINI_API_KEY` | âœ… | - | Gemini APIå¯†é’¥ |
| `PORT` | âŒ | 3001 | æœåŠ¡å™¨ç«¯å£ |
| `NODE_ENV` | âŒ | development | è¿è¡Œç¯å¢ƒ |
| `ALLOWED_ORIGINS` | âŒ | localhost:5173 | å…è®¸çš„å‰ç«¯åŸŸå |
| `MAX_REQUESTS_PER_MINUTE` | âŒ | 60 | APIè°ƒç”¨é¢‘ç‡é™åˆ¶ |
| `MAX_FILE_SIZE` | âŒ | 10485760 | æ–‡ä»¶ä¸Šä¼ å¤§å°é™åˆ¶ |

### CORSé…ç½®

åç«¯é»˜è®¤å…è®¸ä»¥ä¸‹åŸŸåè®¿é—®ï¼š
- `http://localhost:5173` - æœ¬åœ°å¼€å‘
- `http://127.0.0.1:5173` - æœ¬åœ°å›ç¯
- `http://192.168.1.*` - å±€åŸŸç½‘é€šé…ç¬¦

å¦‚éœ€ä¿®æ”¹ï¼Œè¯·ç¼–è¾‘ `ALLOWED_ORIGINS` ç¯å¢ƒå˜é‡ã€‚

## ğŸŒ å±€åŸŸç½‘éƒ¨ç½²

### 1. è·å–æœåŠ¡å™¨IPåœ°å€

```bash
# Linux/macOS
ip addr show | grep inet | grep -v 127.0.0.1

# Windows
ipconfig | findstr "IPv4"
```

### 2. å¯åŠ¨åç«¯æœåŠ¡

```bash
cd backend
PORT=3001 npm start
```

### 3. éƒ¨ç½²å‰ç«¯

```bash
# æ„å»ºå‰ç«¯
cd zhouwenwang-divination
npm run build

# ä½¿ç”¨ç®€å•HTTPæœåŠ¡å™¨æ‰˜ç®¡
npx serve dist -p 3000

# æˆ–ä½¿ç”¨Python
python3 -m http.server 3000 -d dist
```

### 4. è®¿é—®æ–¹å¼

- **åç«¯API**: `http://192.168.1.100:3001`
- **å‰ç«¯ç•Œé¢**: `http://192.168.1.100:3000`

å±€åŸŸç½‘å†…å…¶ä»–è®¾å¤‡å¯ä»¥é€šè¿‡è¿™äº›åœ°å€è®¿é—®å åœç³»ç»Ÿã€‚

## ğŸ”’ å®‰å…¨ç‰¹æ€§

### APIå¯†é’¥ä¿æŠ¤
- âœ… APIå¯†é’¥å®Œå…¨å­˜å‚¨åœ¨æœåŠ¡å™¨ç«¯
- âœ… å‰ç«¯ä»£ç ä¸­ä¸åŒ…å«ä»»ä½•æ•æ„Ÿä¿¡æ¯
- âœ… æ‰€æœ‰Gemini APIè°ƒç”¨é€šè¿‡åç«¯ä»£ç†

### è®¿é—®æ§åˆ¶
- âœ… CORSé…ç½®é™åˆ¶è®¿é—®æ¥æº
- âœ… è¯·æ±‚é¢‘ç‡é™åˆ¶é˜²æ­¢æ»¥ç”¨
- âœ… æ–‡ä»¶ä¸Šä¼ å¤§å°é™åˆ¶

### é”™è¯¯å¤„ç†
- âœ… è¯¦ç»†çš„é”™è¯¯æ—¥å¿—è®°å½•
- âœ… ä¼˜é›…çš„é”™è¯¯å“åº”
- âœ… è‡ªåŠ¨é‡è¯•æœºåˆ¶

## ğŸ“Š æ€§èƒ½ç›‘æ§

### æ—¥å¿—ä¿¡æ¯
æœåŠ¡å™¨ä¼šè¾“å‡ºè¯¦ç»†çš„è¯·æ±‚æ—¥å¿—ï¼š
```
[2024-01-15T10:30:15.123Z] POST /api/gemini/stream - 192.168.1.105
æ­£åœ¨å»ºç«‹æµå¼è¿æ¥: gemini-2.5-flash-lite-preview-06-17
æµå¼å“åº”å®Œæˆï¼ŒåŸå› : STOP
```

### å¥åº·æ£€æŸ¥
å®šæœŸè®¿é—® `/api/health` ç«¯ç‚¹ç›‘æ§æœåŠ¡çŠ¶æ€ï¼š
```bash
curl http://localhost:3001/api/health
```

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

**1. APIå¯†é’¥é”™è¯¯**
```
âŒ GEMINI_API_KEY æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”è¯¥ä»¥ AIza å¼€å¤´
```
è§£å†³ï¼šæ£€æŸ¥ `.env` æ–‡ä»¶ä¸­çš„APIå¯†é’¥æ ¼å¼ã€‚

**2. CORSé”™è¯¯**
```
Access to fetch at 'http://...' from origin 'http://...' has been blocked by CORS policy
```
è§£å†³ï¼šåœ¨ `ALLOWED_ORIGINS` ä¸­æ·»åŠ å‰ç«¯åŸŸåã€‚

**3. æµå¼è¿æ¥å¤±è´¥**
```
æµå¼APIè°ƒç”¨å¤±è´¥: Error: timeout of 60000ms exceeded
```
è§£å†³ï¼šæ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒGemini APIçŠ¶æ€ã€‚

### è°ƒè¯•æ¨¡å¼

å¯ç”¨è¯¦ç»†æ—¥å¿—ï¼š
```bash
LOG_LEVEL=debug npm start
```

## ğŸ“‹ å¼€å‘è¯´æ˜

### ç›®å½•ç»“æ„
```
backend/
â”œâ”€â”€ server.js              # ä¸»æœåŠ¡å™¨æ–‡ä»¶
â”œâ”€â”€ package.json           # ä¾èµ–é…ç½®
â”œâ”€â”€ env.example            # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”œâ”€â”€ start.sh               # å¯åŠ¨è„šæœ¬
â”œâ”€â”€ frontend-integration.js # å‰ç«¯é›†æˆç¤ºä¾‹
â””â”€â”€ README.md              # æœ¬æ–‡æ¡£
```

### å¼€å‘ä¾èµ–
```bash
npm install -D nodemon
npm run dev  # è‡ªåŠ¨é‡å¯æœåŠ¡å™¨
```

### APIæµ‹è¯•
```bash
# æµ‹è¯•å¥åº·æ£€æŸ¥
curl http://localhost:3001/api/health

# æµ‹è¯•æ ‡å‡†API
curl -X POST http://localhost:3001/api/gemini/generate \
  -H "Content-Type: application/json" \
  -d '{"contents":[{"parts":[{"text":"æµ‹è¯•æ¶ˆæ¯"}]}]}'

# æµ‹è¯•æµå¼APIï¼ˆéœ€è¦æ”¯æŒSSEçš„å®¢æˆ·ç«¯ï¼‰
curl -N http://localhost:3001/api/gemini/stream \
  -H "Content-Type: application/json" \
  -d '{"contents":[{"parts":[{"text":"æµ‹è¯•æµå¼æ¶ˆæ¯"}]}]}'
```

## ğŸ¯ å‰ç«¯é›†æˆ

å‚è€ƒ `frontend-integration.js` æ–‡ä»¶ä¸­çš„ç¤ºä¾‹ä»£ç ï¼Œå°†ç°æœ‰çš„ç›´æ¥Gemini APIè°ƒç”¨æ›¿æ¢ä¸ºåç«¯è°ƒç”¨ã€‚

ä¸»è¦ä¿®æ”¹ç‚¹ï¼š
1. å°†APIè°ƒç”¨åœ°å€æ”¹ä¸ºåç«¯åœ°å€
2. ç§»é™¤å‰ç«¯APIå¯†é’¥é…ç½®
3. ä½¿ç”¨æµå¼APIå®ç°å®æ—¶å“åº”æ•ˆæœ

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š

1. **APIå¯†é’¥é…ç½®** - ç¡®ä¿ `.env` æ–‡ä»¶æ­£ç¡®è®¾ç½®
2. **ç½‘ç»œè¿æ¥** - ç¡®ä¿èƒ½è®¿é—®Google Gemini API
3. **ç«¯å£å ç”¨** - ç¡®ä¿3001ç«¯å£æœªè¢«å…¶ä»–ç¨‹åºå ç”¨
4. **é˜²ç«å¢™è®¾ç½®** - ç¡®ä¿å±€åŸŸç½‘è®¾å¤‡èƒ½è®¿é—®æœåŠ¡å™¨

---

**æ„¿å¤ä»£æ™ºæ…§ä¸ç°ä»£ç§‘æŠ€çš„ç»“åˆï¼Œä¸ºæ‚¨å’Œæ‚¨çš„ç”¨æˆ·æŒ‡å¼•äººç”Ÿæ–¹å‘ï¼** ğŸŒŸ 